let sheetLink = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1SvlgwjDPvbz9tVZ1MTRq_AkVonfs-YWAoCUpgYFV8t5sSL7SN58lyAfWM9LURf6HAsurzU52f1kw/pub?gid=145287685&single=true&output=csv"
//let overrideLinks = ["wide_ann.jackson_viz_SuperBowl2018LIIBigGameBattle_BIGGAMEBATTLE_Dashboard1.png", "wide_corey.jones_viz_FindingOasesInFoodDeserts_Dashboard1_Dashboard1.png", "wide_dilyana2344_viz_Baseball_34_Dashboard1_Dashboard1.png", "wide_jeff.plattner4532_viz_JordanCareerScoring_PlayerViz_Dashboard1.png", "wide_jessica7027_viz_VFSGFeb_INVISIBLECONSEQUENCES_Dashboard1.png", "wide_jusdespommes_viz_MAKOVERMONDAY-TRUMPSEXECUTIVETIME_MAKOVERMONDAY-TRUMPSEXECUTIVETIME_Dashboard1.png", "wide_kasia.gasiewska.holc_viz_GarbageintheOceanVOTD_GarbageintheOcean_Dashboard1.png", "wide_ken.flerlage_viz_AHistoryoftheWorldCup_WorldCup_Dashboard1.png", "wide_klaus.schulte_viz_Becker_0_Becker_Dashboard1.png", "wide_klaus.schulte_viz_TotalAnnualLossofBeeColoniesintheUS_Dashboard1_Dashboard1.png", "wide_lilach.manheim_viz_AnUm____Analysis_Um_____Dashboard1.png", "wide_lindsay.betzendahl_viz_StateMedigapCosts-ProjectHealthViz_Medigap_Dashboard1.png", "wide_ludovic.tavernier_viz_MakeOverMonday-Overtourism_Tableaudebord1_Dashboard1.png", "wide_mariannik_viz_Internetfamiglieitaliane2005-2016_Internetnellefamiglie_Dashboard1.png", "wide_mikevizneros_viz_PoliticalDW_TheAmericanPoliticalUniverse_Dashboard1.png", "wide_mina.ozgen_viz_StarcraftIIPlayerNetwork_StarcraftIIPlayerNetwork_Dashboard1.png", "wide_missleigh_viz_USFruitConsumption_Fruit_Dashboard1.png", "wide_nai.louza_viz_RatiosofInequity_RatiosofInequity_Dashboard1.png", "wide_neil.richards_viz_smallisbeautiful-TP_Dashboard52_Dashboard1.png", "wide_shawn.m.levin_viz_Prince_HisPurpleMajesty_Dashboard1.png", "wide_siyu.bao_viz_2018W27NewYorkRatSightings_NewYorkRatSightings_Dashboard1.png", "wide_sparsonsdataviz_viz_SixNations136YearHistorySportsVizSunday_FULLHISTORYOFTHESIXNATIONS_Dashboard1.png", "wide_sue.grist_viz_ExploreAirlineDataFINALSueGrist2017-06-05_Story1_Dashboard1.png", "wide_theboeingcompany_viz_BoeingCommercialMarketOutlook2018-2037_CommercialMarketOutlook_Dashboard1.png", "wide_valerie1556_viz_DataforaCause-GlobalPeaceScores_DASHBOARD_Dashboard1.png", "wide_yvette_viz_GenderEthnicDisparitiesinTechCompanies_GenderEthnicdisparitiesinTechCompanies_Dashboard1.png", "wide_yvette_viz_Womensrepresentationinpoliticsvizforsocialgood_WomeninPolitics_Dashboard1.png"]
let overrideLinks = ["wide_ann.jackson_viz_SuperBowl2018LIIBigGameBattle_BIGGAMEBATTLE_Dashboard1.png", "wide_dilyana2344_viz_Baseball_34_Dashboard1_Dashboard1.png", "wide_jeff.plattner4532_viz_JordanCareerScoring_PlayerViz_Dashboard1.png", "wide_jessica7027_viz_VFSGFeb_INVISIBLECONSEQUENCES_Dashboard1.png", "wide_jusdespommes_viz_MAKOVERMONDAY-TRUMPSEXECUTIVETIME_MAKOVERMONDAY-TRUMPSEXECUTIVETIME_Dashboard1.png", "wide_klaus.schulte_viz_TotalAnnualLossofBeeColoniesintheUS_Dashboard1_Dashboard1.png", "wide_lilach.manheim_viz_AnUm____Analysis_Um_____Dashboard1.png", "wide_lindsay.betzendahl_viz_StateMedigapCosts-ProjectHealthViz_Medigap_Dashboard1.png", "wide_ludovic.tavernier_viz_MakeOverMonday-Overtourism_Tableaudebord1_Dashboard1.png", "wide_mariannik_viz_Internetfamiglieitaliane2005-2016_Internetnellefamiglie_Dashboard1.png", "wide_mikevizneros_viz_PoliticalDW_TheAmericanPoliticalUniverse_Dashboard1.png", "wide_mina.ozgen_viz_StarcraftIIPlayerNetwork_StarcraftIIPlayerNetwork_Dashboard1.png", "wide_missleigh_viz_USFruitConsumption_Fruit_Dashboard1.png", "wide_nai.louza_viz_RatiosofInequity_RatiosofInequity_Dashboard1.png", "wide_siyu.bao_viz_2018W27NewYorkRatSightings_NewYorkRatSightings_Dashboard1.png", "wide_sue.grist_viz_ExploreAirlineDataFINALSueGrist2017-06-05_Story1_Dashboard1.png", "wide_theboeingcompany_viz_BoeingCommercialMarketOutlook2018-2037_CommercialMarketOutlook_Dashboard1.png", "wide_yvette_viz_GenderEthnicDisparitiesinTechCompanies_GenderEthnicdisparitiesinTechCompanies_Dashboard1.png"]
// let overrideLinks = ["https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Becker.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/BIG%20GAME%20BATTLE.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Dashboard%205%20%282%29.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/BIG%20GAME%20BATTLE%281%29.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Dashboard%201%282%29.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/DASHBOARD.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Garbage%20in%20the%20Ocean.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/FULL%20HISTORY%20OF%20THE%20SIX%20NATIONS.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Gender%26Ethnic%20disparities%20in%20Tech%20Companies.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/His%20Purple%20Majesty.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/INVISIBLE%20CONSEQUENCES.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Internet%20nelle%20famiglie.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/MAKOVERMONDAY%20-%20TRUMP%27S%20%27EXECUTIVE%20TIME%27%281%29.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Ratios%20of%20Inequity.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/New%20York%20Rat%20Sightings.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/PlayerViz.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Starcraft%20II%20Player%20Network.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Um.....png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Tableau%20de%20bord%201.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/Women%20in%20Politics.png", "https://data.cyverse.org/dav-anon/iplant/home/baylyd/dlx_downloads/World%20Cup.png"]


let refreshSeconds = 30 
let refreshMS = refreshSeconds * 1000
// reload this page every 5 minutes
console.log(window.location.search)
let params = new URLSearchParams(window.location.search)
let group = 0
if (params.get("group") != undefined) {
  group = parseInt(params.get("group"))
}
if (params.get("synced") == undefined) {
  // this means that we need to wait for a certain number of seconds and then reload the page, but add a sync tag to it
  let d = new Date()
  let s = d.getSeconds()
  // set a timeout to happen in next 10 seconds
  let mods = s % 10
  setTimeout(() => {
    window.location.assign(`https://devinbayly.github.io/catalyst_playlists/eventstatic/index.html?group=${group}&synced=1`)
  }, (10 - mods) * 1000)
} else {
  let p_update_interval
  // set up the timer for the countdown text
  
  console.log(params)
  // get the number of the window group, and this will make sure we don't re-use any links
  // this might also mean that we need to set a reset on the window to sync it (both windows opened at different times will start their refresh timers separately)
  function shuffle(array) {
    let currentIndex = array.length, randomIndex;

    // While there remain elements to shuffle...
    while (currentIndex != 0) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;

      // And swap it with the current element.
      [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
    }

    return array;
  }

  async function triggerPlaylist() {

    console.log("starting")

    let holder = document.querySelector("#holder")
    // make 4 smaller divs for the videos
    let subholders = Array(2).fill(0).map((e, i) => {
      let d = document.createElement("div")
      let paraholder = document.createElement("div")
      paraholder.className = "paraholder"
      let p = document.createElement("p")
      // p.className = "groupid"
      // p.innerHTML = `${group * 2 + i + 1}`
      d.id = `holder${i}`
      d.className = "subholder"
      holder.append(d)
      // d.append(paraholder)
      // paraholder.append(p)

      return d
    })
    // let text = (await fetch(sheetLink).then(res => res.text()))
    // let data = d3.csvParse(text, d3.autoType)
    // remove this later

    data = overrideLinks.map(e => ({ link: e, tag: "vizzies" }))
    setTimeout(() => {
      window.location.reload()
    }, data.length * refreshMS)

    //data = shuffle(data)
    //slice skips the column header
    let subdata = data.filter(e => /vizzies/.test(e.tag))
    let indices = Array(subdata.length).fill(0).map((e, i) => i)
    let groupIndices
    // if (group == 0) {
    //   groupIndices = indices.slice(0, subdata.length / 2)
    // } else {
    //   groupIndices = indices.slice(subdata.length / 2)
    // }
    groupIndices = indices
    groupIndices = shuffle(groupIndices)
    function addToSubHolder(subholder, indices) {
      let img
      let video
      let linkNumber = 0
      for (let i of indices) {
        let row = subdata[i]
        let link = row.link
        console.log("link is", link)
        console.log("setting timeout", link, 10 * 1000 * linkNumber)
        // this will ensure that the pages get to play for a certain amount of time

        setTimeout(() => {
          let playobject

          if (video) { video.remove() }
          if (img) { img.remove() }
          img = document.createElement("img")

          playobject = img

          subholder.append(playobject)

          playobject.src = `https://data.cyverse.org/dav-anon/iplant/home/baylyd/screen_grabs/${link}`
          // figure out the image dimensions here, and the introduce a slow scroll
          // img.onload = (e)=> {
          //   console.log(e)
          //   console.log(img.size)
          //   let height = img.height
          //   let width = img.width
          //   // get the size of the holder right now
          //   let intervalid
          //   let freq = 50
          //   let divscale = refreshMS/freq
          //   if (height > width) {
          //     let bb = subholder.getBoundingClientRect()
          //     let sheight = subholder.scrollHeight
          //     let sh = sheight/(divscale)
          //     intervalid = setInterval(() => {
          //       subholder.scrollTop += sh
          //     },freq)


          //   } else {
          //     let bb = subholder.getBoundingClientRect()
          //     let swidth = subholder.scrollWidth
          //     // math here is we divide by the number of iterations the interval needs to run withing the length of the image showing cycle
          //     let sw = swidth/(divscale)
          //     intervalid = setInterval(() => {
          //       subholder.scrollLeft += sw
          //     },freq)
          //   }
          //   setTimeout(()=> {
          //       clearInterval(intervalid)
          //     },refreshMS)

          // }
        }, 20*1000 * linkNumber)

        linkNumber += 1


      }

    }
    let indicesPerD = Math.floor(groupIndices.length / 2)
    subholders.map((d, i) => {
      let subindices = groupIndices.slice(i * indicesPerD, (i + 1) * indicesPerD)

      addToSubHolder(d, subindices)

    })

  }
  function slowroll() {
    let start = 0
    setInterval(() => {
      start += 10
      window.scroll({ top: start, behavior: "smooth" })
    }
      , 100)
  }
  window.onload = triggerPlaylist
}
